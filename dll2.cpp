#include <windows.h>
#include <psapi.h>
#include "version.hpp"
#include "Utils.hpp"

static std::string GetProcessBaseName() {
  std::vector<char> buf(MAX_PATH);
  GetModuleBaseName(GetCurrentProcess(), NULL, buf.data(), buf.size());
  return std::string{ buf.data() };
}

static void MyMain() {
  auto proc_name = GetProcessBaseName();
  auto module_span = GetModuleSpan();
  LOG(proc_name.c_str() << ": " << hash_str(proc_name));
  switch (hash_str(proc_name)) {
  case 3544157841: { // Ba.....p
    auto hexpattern1 = "488D15????????488B88????????0F1F8400????????0FB7045948FFC3663B445AFE75??4883FB0475??663B445AFE75??C786????????201B0000EB??";
    auto hexpattern2 = "??????????????????????????????????????????????????????????????????????00??????????????????????????????????????????????????";
    PatternPatch(module_span, hexpattern1, hexpattern2);
    break;
  }
  case 913266112: { // 01......r
    PatternPatch(module_span, "74 ?? B8 ?? ?? 00 00 48 ?? ?? ?? ?? 48 83 C4 20 5F C3 E8", "90 90 ?? DB 00 ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??");
    PatternPatch(module_span, "75 ?? 48 ?? ?? ?? ?? ?? ?? 48 8B CF FF 15 ?? ?? ?? ?? C7 06 00 00 00 00 E9", "90 90 ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ?? ??");
    break;
  }
  case 1183907815: { // BC.....e
    std::span src_span{ "++11Ik:7EFlNLs6Yqc3p-LtUOXBElimekQm8e3BTSeGhxhlpmVDeVVrrUAkLTXpZ7mK6jAPAOhyHiokPtYfmokklPELfOxt1s5HJmAnl-5r8YEvsQXY8-dm6EFwYJlXgWOCutNn2+FsvA7EXvM-2xZ1MW8LiGeYuXCA6Yt2wTuU4YWM+ZUBkIGEs1QRNRYIeGB9GB9YsS8U2-Z3uunZPgnA5pF+E8BRwYz9ZE--VFeKCPamspG7tdvjA3AJNRNrCVmJvwq5SqgEQwINdcmwwjmc4JetVK76og5A5sPOIXSwOjlYK+Sm8rvlJZoxh0XFfyioHz48JV3vXbBKjgAlPAc7Np1+wk", 349 };
    std::span dst_span{ "++11Ik:7EFlNLs6Yqc3p-LtUOXBElimekQm8e3BTSeGhxhlpmVDeVVrrUAkLTXpZ7mK6jAPAOhyHiokPtYfmokklPELfOxt1s5HJmAnl-5r8YEvsQXY8-dm6EFwYJlXgWOCutNn2+FsvA7EXvM-2xZ1MW8LiGeYuXCA6Yt2wTuU4YWM+ZUBkIGEs1QRNRYIeGB9GB9YsS8U2-Z3uunZPgnA5pF+E8BRwYz9ZE--VFeKCPamspG7tdvjA3AJNRNrCVmJvwq5SqgEQwINdcmwwjmc4JetVK76og5A5sPOIXSwOjlYK+Sm8rvlJZoxh0XFfyioHz48JV3vXbBKjgAlPAc7Npn+wk", 349 };

    if (!patch(module_span, src_span, dst_span)) {
      LOG("pattern not found");
    }
    break;
  }
  }
}

BOOL WINAPI DllMain(HINSTANCE hInstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
  switch (fdwReason) {
  case DLL_PROCESS_ATTACH:
    dll.DllInit(LoadSystemLibrary("version.dll"));
    MyMain();
    break;
  case DLL_PROCESS_DETACH:
    break;
  }

  return TRUE;
}
